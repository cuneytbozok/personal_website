---
import SectionHeader from './SectionHeader.astro';

const companyTimeline = [
  { company: 'EPAM Systems', startYear: 2022 },
  { company: 'Softtech', startYear: 2018, endYear: 2022 },
  { company: 'Deloitte Turkey', startYear: 2017, endYear: 2018 },
];

const currentYear = new Date().getFullYear();
const minYear = Math.min(...companyTimeline.map((c) => c.startYear));
const maxYear = currentYear;
const yearRange = maxYear - minYear;
const safeRange = yearRange === 0 ? 1 : yearRange;
const showMidTick = yearRange >= 4;
const midYear = Math.round((minYear + maxYear) / 2);
const timelineSegments = companyTimeline.map((company) => {
  const endYear = company.endYear ?? currentYear;
  const leftPct = yearRange === 0
    ? 0
    : ((maxYear - endYear) / safeRange) * 100;
  const widthPct = yearRange === 0 ? 100 : ((endYear - company.startYear) / safeRange) * 100;

  return {
    ...company,
    endYear,
    leftPct,
    widthPct,
  };
});

const companies = [
  {
    name: 'EPAM Systems',
    period: '2022 – Present',
    progression: 'Senior Developer → Lead Developer → Solution Architect',
    roles: [
      {
        title: 'Solution Architect / Lead ServiceNow Developer',
        period: 'Sep 2024 – Present',
        industry: 'Telecom · Technology & Networking · Pharma',
        highlights: [
          'Created target-state architecture and implementation guidelines for a headless B2B telco marketplace on ServiceNow (CSM, SOM, TNI, telco orchestration), mapping TM Forum Open APIs to ServiceNow data models and REST interfaces.',
          'Defined API-driven channel-to-platform integration patterns, responsibility boundaries, and lifecycle/state flows across lead-to-order-to-fulfillment.',
          'Produced delivery-ready architecture artifacts—HLDs, sequence diagrams, domain model/state diagrams, ADRs, and API contracts—to align teams and vendors.',
          'Acted as design authority (OOB vs custom) and led architecture workshops/reviews with integrators and platform vendors.',
          'Led discovery and future-state design across ITSM, Employee Experience, and AI; assessed CMDB/CSDM and ITSM maturity (Change, Major Incident, Knowledge, Universal Request) and produced a phased roadmap with executive presentation.',
          'Delivered demos and POCs covering Now Assist, Agentic AI, App Engine/Creator Studio, Employee Center Pro, Walk-Up Experience, and DevOps Change Velocity.',
          'Built Virtual Agent experiences and Service Portal customizations (themes/widgets/UX); developed a Finance Mailbox Queue Management scoped app using AI-assisted classification and SAP document retrieval via UiPath integration.',
          'Designed custom UI components (UI Macros), Outlook Actionable Messages for context-aware inbox actions, and contributed to AI-based reporting enhancements.',
        ],
      },
      {
        title: 'Senior ServiceNow Developer',
        period: 'Sep 2022 – Sep 2024',
        industry: 'Wellness & Meditation · Enterprise Software',
        highlights: [
          'Integrated third-party tools with ServiceNow via REST and delivered workforce optimization solutions including shift planning and recurring-event management.',
          'Customized workspaces with UI Builder and delivered CSM/Universal Request enhancements using Script Includes, Business Rules, and Flow Designer.',
          'Configured Virtual Agent Bot to integrate with Microsoft Teams using VA API and REST methods; produced developer enablement documentation.',
          'Developed custom-scoped application (Localization Testing Assistant) with Scripted REST API for multi-instance integration; authored threat model and technical design docs.',
          'Implemented Jamf and Okta integrations for automated license and role request flows.',
        ],
      },
    ],
  },
  {
    name: 'Softtech',
    period: '2018 – 2022',
    progression: 'Consultant → Senior Consultant → Architect',
    roles: [
      {
        title: 'ServiceNow Architect',
        period: 'Apr 2022 – Sep 2022',
        industry: 'E-Commerce · Manufacturing',
        highlights: [
          'Owned development and maintenance of enterprise ServiceNow instances; delivered multi-system integrations (IBM ServiceNow, SAP, third-party ITSM tools) and event management integrations (Netbrain/Nagios/SCOM).',
          'Activated Slack Integration and Virtual Agent plugins; designed and delivered a custom Virtual Agent tailored to client-specific usage scenarios.',
          'Conducted business analyses and technical assessments, designing robust ITSM data model templates with assignment rules, business services, and user criteria.',
        ],
      },
      {
        title: 'Senior ServiceNow Consultant',
        period: 'Nov 2020 – Apr 2022',
        industry: 'Manufacturing · Food Production · ITSM Platforms',
        highlights: [
          'Deployed MID Servers; integrated Azure SSO/LDAP; implemented custom inbound actions for event sources without APIs.',
          'Designed custom HR Service Delivery Portal with bespoke widgets, Angular-based header menu components, and base64-encoded font/CSS implementation.',
          'Delivered portal/workflow implementations for ITSM and HR use cases across multiple clients.',
        ],
      },
      {
        title: 'ServiceNow Consultant',
        period: 'Nov 2018 – Nov 2020',
        industry: 'B2B E-Commerce · Enterprise',
        highlights: [
          'Created a public ServiceNow portal with company registration, OOB approval workflows, and integrated online payment system.',
          'Built asset and model pipelines using Asset Management; designed portal as an e-commerce experience alongside web designers.',
          'Implemented SEO for ServiceNow and custom URL configuration for the instance.',
        ],
      },
    ],
  },
  {
    name: 'Deloitte Turkey',
    period: '2017 – 2018',
    progression: 'Specialist → Consultant',
    roles: [
      {
        title: 'ServiceNow Consultant',
        period: 'Jun 2018 – Nov 2018',
        industry: 'Banking & Financial Services',
        highlights: [
          'Improved CMDB health using Discovery Module and CMDB Health Jobs; created a CMDB Maintenance lifecycle for duplicate, orphan, and stale CIs.',
          'Conducted business analyses for Request and Incident Management, developing custom ITSM workflows and a bespoke Business Impact Analysis form and widget.',
        ],
      },
      {
        title: 'ServiceNow Specialist',
        period: 'Nov 2017 – Jun 2018',
        industry: 'Food & Consumer Goods',
        highlights: [
          'Implemented ITSM workflows (Request, Incident, Change) and designed ServiceNow portal according to customer branding guidelines.',
          'Configured ServiceNow Mobile Classic App and created custom reports, widgets, and portal pages for mobile viewing.',
        ],
      },
    ],
  },
];

const storyStepCount = companies.length;
---

<section
  id="experience"
  class="section-fade mx-auto max-w-5xl px-6 py-16 lg:py-24"
  data-motion="reveal handoff"
  data-motion-once="false"
  data-motion-distance="26"
  aria-labelledby="experience-heading"
>
  <div data-motion-stage>
    <div data-motion="parallax" data-motion-speed="0.09">
      <SectionHeader number="02" title="Experience" id="experience-heading" />
    </div>

    <div class="space-y-14">
      <div
        class="experience-story"
        data-motion="pin-story"
        data-story-steps={storyStepCount}
        style={`--story-steps: ${storyStepCount};`}
      >
        <div class="experience-story__sticky space-y-8">
          <h3 class="text-2xl font-semibold text-text" data-motion="parallax" data-motion-speed="0.08">
            Experience
          </h3>

        <div class="grid gap-8 lg:grid-cols-[200px_1fr]">
          <div class="flex flex-col gap-3">
            <div class="relative -mx-6 lg:mx-0">
              <div
                class="experience-tablist -mx-6 flex flex-row gap-4 overflow-x-auto px-6 pb-2 lg:mx-0 lg:flex-col lg:overflow-visible lg:px-0 lg:pb-0 [scrollbar-width:thin]"
                role="tablist"
                aria-label="Company tabs"
              >
                {
                  companies.map((company, i) => (
                    <button
                      type="button"
                      class="experience-tab shrink-0 -ml-[2px] border-l-2 border-border px-4 py-2 text-left font-mono text-sm text-text-muted transition-colors hover:border-accent hover:text-accent data-[active]:border-accent data-[active]:text-accent lg:shrink"
                      data-index={i}
                      aria-selected={i === 0}
                      aria-controls={`panel-${i}`}
                      id={`tab-${i}`}
                      role="tab"
                      data-active={i === 0 ? '' : undefined}
                    >
                      {company.name}
                    </button>
                  ))
                }
              </div>
              <div
                class="pointer-events-none absolute right-0 top-0 h-full w-10 bg-gradient-to-l from-bg to-transparent lg:hidden"
                aria-hidden="true"
              ></div>
            </div>

            <div class="experience-timeline" aria-hidden="true">
              <div class="experience-timeline-line"></div>
              <div class="experience-timeline-segments">
                {
                  timelineSegments.map((segment, i) => (
                    <span
                      class="experience-timeline-segment"
                      data-index={i}
                      data-active={i === 0 ? '' : undefined}
                      style={`--segment-left: ${segment.leftPct}%; --segment-width: ${segment.widthPct}%;`}
                    ></span>
                  ))
                }
              </div>
              <div class="experience-timeline-labels">
                <span class="experience-timeline-label is-start">Present</span>
                {showMidTick && (
                  <span class="experience-timeline-label is-mid">{midYear}</span>
                )}
                <span class="experience-timeline-label is-end">{minYear}</span>
              </div>
            </div>
          </div>

          <div class="experience-panels min-w-0">
            {
              companies.map((company, i) => (
                <div
                  id={`panel-${i}`}
                  role="tabpanel"
                  aria-labelledby={`tab-${i}`}
                  class={`experience-panel ${i === 0 ? '' : 'hidden'}`}
                  data-index={i}
                  data-active={i === 0 ? '' : undefined}
                  aria-hidden={i === 0 ? 'false' : 'true'}
                >
                  <h3 class="text-xl font-semibold text-text break-words">
                    {company.name}
                  </h3>
                  <p class="mt-1 font-mono text-sm text-text-dimmer">{company.period}</p>
                  <p class="mt-2 font-mono text-xs text-accent">
                    Progression: {company.progression}
                  </p>

                  <div class="mt-8 space-y-8">
                    {
                      company.roles.map((role, roleIndex) => (
                        <div>
                          {roleIndex > 0 && (
                            <div
                              class="mb-6 flex items-center gap-2 font-mono text-xs text-accent"
                              aria-hidden="true"
                            >
                              <span
                                class="inline-flex items-center gap-1 rounded border border-accent/50 px-2 py-0.5"
                              >
                                <span aria-hidden="true">↑</span> Promotion
                              </span>
                            </div>
                          )}
                          <h4 class="text-lg font-medium text-text">
                            {role.title}{' '}
                            <span class="text-text-muted">— {role.period}</span>
                          </h4>
                          {role.industry && (
                            <p class="mt-1 font-mono text-xs text-text-dimmer">
                              {role.industry}
                            </p>
                          )}
                          <ul class="mt-3 space-y-2">
                            {
                              role.highlights.map((h) => (
                                <li class="flex gap-3 text-text-muted">
                                  <span class="mt-0.5 shrink-0 text-accent">▹</span>
                                  <span class="min-w-0 break-words text-sm">{h}</span>
                                </li>
                              ))
                            }
                          </ul>
                        </div>
                      ))
                    }
                  </div>
                </div>
              ))
            }
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (() => {
    const section = document.querySelector('#experience');
    if (!(section instanceof HTMLElement)) return;

    const tabs = Array.from(section.querySelectorAll('.experience-tab'));
    const panels = Array.from(section.querySelectorAll('.experience-panel'));
    const tabList = section.querySelector('.experience-tablist');
    const timelineSegments = Array.from(section.querySelectorAll('.experience-timeline-segment'));
    const story = section.querySelector('[data-motion~="pin-story"]');
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)');

    if (tabs.length === 0 || panels.length === 0 || timelineSegments.length === 0) return;

    let activeIndex = Math.max(
      0,
      tabs.findIndex((tab) => tab.hasAttribute('data-active'))
    );
    let isManualStoryJump = false;
    const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
    const getNavOffset = () => {
      const nav = document.querySelector('nav[aria-label="Main navigation"]');
      return nav instanceof HTMLElement ? nav.getBoundingClientRect().height : 0;
    };
    const getPageTop = (element) => element.getBoundingClientRect().top + window.scrollY;

    const clearHover = () => {
      timelineSegments.forEach((segment) => segment.removeAttribute('data-hover'));
    };

    const scrollTabIntoView = (tab) => {
      if (!tabList || !tab) return;
      tab.scrollIntoView({
        behavior: prefersReduced.matches ? 'auto' : 'smooth',
        inline: 'center',
        block: 'nearest',
      });
    };

    const setActiveIndex = (index, { animate = true } = {}) => {
      const nextIndex = Math.min(Math.max(index, 0), panels.length - 1);
      const isChanged = nextIndex !== activeIndex;
      activeIndex = nextIndex;

      tabs.forEach((tab, tabIndex) => {
        const isActive = tabIndex === activeIndex;
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        if (isActive) {
          tab.setAttribute('data-active', '');
        } else {
          tab.removeAttribute('data-active');
        }
      });

      panels.forEach((panel, panelIndex) => {
        const isActive = panelIndex === activeIndex;
        panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');

        if (isActive) {
          panel.classList.remove('hidden');
          panel.setAttribute('data-active', '');

          if (animate && isChanged && !prefersReduced.matches) {
            panel.classList.remove('is-entering');
            void panel.offsetWidth;
            panel.classList.add('is-entering');
          } else {
            panel.classList.remove('is-entering');
          }
          return;
        }

        panel.classList.add('hidden');
        panel.classList.remove('is-entering');
        panel.removeAttribute('data-active');
      });

      timelineSegments.forEach((segment, segmentIndex) => {
        if (segmentIndex === activeIndex) {
          segment.setAttribute('data-active', '');
        } else {
          segment.removeAttribute('data-active');
        }
      });
    };

    const syncProgressToIndex = (progress) => {
      const boundedProgress = Math.min(Math.max(progress, 0), 1);
      const nextIndex = Math.min(
        panels.length - 1,
        Math.floor(boundedProgress * panels.length)
      );
      setActiveIndex(nextIndex, { animate: false });
    };

    const scrollStoryToIndex = (index) => {
      if (!(story instanceof HTMLElement)) return;
      if (story.getAttribute('data-pin') !== 'active') return;

      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
      const stickyOffset = getNavOffset() + 24;
      const targetProgress = panels.length <= 1
        ? 0
        : clamp((index + 0.5) / panels.length, 0, 1);
      const total = Math.max(story.offsetHeight - viewportHeight + stickyOffset, 1);
      const destination = Math.max(
        getPageTop(story) - stickyOffset + targetProgress * total,
        0
      );

      isManualStoryJump = true;
      story.style.setProperty('--story-progress', targetProgress.toFixed(4));

      window.scrollTo({
        top: destination,
        behavior: 'auto',
      });

      window.requestAnimationFrame(() => {
        setActiveIndex(index, { animate: false });
        story.style.setProperty('--story-progress', targetProgress.toFixed(4));
      });

      // Keep ignoring scroll-driven progress long enough for Layout's smoothing to settle.
      // Otherwise motion:story-progress fires with intermediate values and causes
      // panels to flash through Deloitte → Softtech → EPAM before landing.
      const settleMs = 420;
      window.setTimeout(() => {
        isManualStoryJump = false;
      }, settleMs);
    };

    const onStoryProgress = (event) => {
      if (!(story instanceof HTMLElement)) return;
      if (story.getAttribute('data-pin') !== 'active' || prefersReduced.matches) return;
      if (isManualStoryJump) return;
      const rawProgress = Number(event.detail?.rawProgress);
      if (Number.isFinite(rawProgress)) {
        syncProgressToIndex(rawProgress);
        return;
      }

      const progress = Number(event.detail?.progress);
      if (!Number.isFinite(progress)) return;
      syncProgressToIndex(progress);
    };

    if (story instanceof HTMLElement) {
      story.addEventListener('motion:story-progress', onStoryProgress);
    }

    tabs.forEach((tab, index) => {
      tab.addEventListener('click', () => {
        setActiveIndex(index, { animate: false });
        scrollTabIntoView(tab);
        scrollStoryToIndex(index);
      });

      tab.addEventListener('mouseenter', () => {
        timelineSegments.forEach((segment, segmentIndex) => {
          if (segmentIndex === index) {
            segment.setAttribute('data-hover', '');
          } else {
            segment.removeAttribute('data-hover');
          }
        });
      });

      tab.addEventListener('mouseleave', clearHover);
      tab.addEventListener('focus', () => {
        timelineSegments.forEach((segment, segmentIndex) => {
          if (segmentIndex === index) {
            segment.setAttribute('data-hover', '');
          } else {
            segment.removeAttribute('data-hover');
          }
        });
      });
      tab.addEventListener('blur', clearHover);
    });

    setActiveIndex(activeIndex, { animate: false });
  })();
</script>
